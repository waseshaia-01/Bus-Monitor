<!DOCTYPE html>
<html>
<head>
  <title>Bus QR Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #reader { width: 100%; max-width: 400px; margin: auto; }
    select, button { padding: 10px; margin: 5px 0; width: 100%; }
    #status { margin-top: 10px; font-weight: bold; }
    .success { color: green; }
    .error { color: red; }
    .warning { color: orange; }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- QR Scanner -->
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <h2>Bus QR Scanner</h2>

  <label>Select Bus:</label>
  <select id="busSelect">
    <option value="">-- Select Bus --</option>
    <option value="Bus 1">Bus 1</option>
    <option value="Bus 2">Bus 2</option>
    <option value="Bus 3">Bus 3</option>
    <option value="Bus 4">Bus 4</option>
    <option value="Bus 5">Bus 5</option>
    <option value="Bus 6">Bus 6</option>
    <option value="Bus 7">Bus 7</option>
    <option value="Bus 8">Bus 8</option>
    <option value="Bus 9">Bus 9</option>
    <option value="Bus 10">Bus 10</option>
    <option value="Bus 11">Bus 11</option>
    <option value="Bus 12">Bus 12</option>
  </select>

  <div id="reader"></div>
  <div id="status">Idle</div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCheUCoG-3z1OPkRAApPNO0S4AaBWW-WAc",
      authDomain: "bus-monitor-c6973.firebaseapp.com",
      projectId: "bus-monitor-c6973",
      storageBucket: "bus-monitor-c6973.firebasestorage.app",
      messagingSenderId: "858489773302",
      appId: "1:858489773302:web:21872c4b9df745c497a0d7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const busSelect = document.getElementById("busSelect");
    const statusDiv = document.getElementById("status");

    async function handleScan(qr) {
      const code = (qr || "").trim();
      const bus = busSelect.value;
      if (!bus) { alert("Please select a bus first!"); return; }
      if (!code) return;

      try {
        const attRef = db.collection("buses").doc(bus).collection("attendees").doc(code);
        const attSnap = await attRef.get();

        if (!attSnap.exists) {
          statusDiv.className = "error";
          statusDiv.textContent = "❌ Not in attendee list.";
          return;
        }

        const attendee = attSnap.data();
        if (attendee.scanned) {
          statusDiv.className = "warning";
          statusDiv.textContent = `⚠ Already scanned: ${attendee.name}`;
          return;
        }

        // Transaction: mark scanned + increment bus count
        await db.runTransaction(async (tx) => {
          const att = await tx.get(attRef);
          if (!att.exists) throw new Error("Not in list.");
          if (att.data().scanned) return; // already scanned
          tx.update(attRef, {
            scanned: true,
            scannedAt: new Date()
          });
          const busRef = db.collection("buses").doc(bus);
          tx.set(busRef, {
            numScanned: firebase.firestore.FieldValue.increment(1),
            updatedAt: new Date()
          }, { merge: true });
        });

        statusDiv.className = "success";
        statusDiv.textContent = `✅ Scanned: ${attendee.name}`;

      } catch (err) {
        console.error(err);
        statusDiv.className = "error";
        statusDiv.textContent = "Error saving scan: " + (err.message || err);
      }
    }

    function onScanSuccess(decodedText) {
      handleScan(decodedText);
    }

    const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
    scanner.render(onScanSuccess);
  </script>
</body>
</html>
