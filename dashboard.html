<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bus QR Monitor — Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    h1 { font-size: 18px; margin: 0; }
    a.btn { padding: 8px 14px; border-radius: 8px; background: #f0f0f0; text-decoration: none; color: #000; }
    .grid { display: grid; gap: 10px; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; background: #fff; }
    .card h3 { margin: 0 0 6px; font-size: 16px; }
    details { margin-top: 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 6px; }
    th, td { border-bottom: 1px solid #eee; padding: 6px; font-size: 14px; }
    th { background: #f8f8f8; }
    .muted { color: #666; font-size: 14px; }
  </style>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <h1>Bus QR Monitor — Dashboard</h1>
    <a class="btn" href="./index.html">← Back to Scanner</a>
  </header>

  <main>
    <div class="grid" id="grid"></div>
  </main>

  <script>
    // --- Your Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyCheUCoG-3z1OPkRAApPNO0S4AaBWW-WAc",
      authDomain: "bus-monitor-c6973.firebaseapp.com",
      projectId: "bus-monitor-c6973",
      storageBucket: "bus-monitor-c6973.firebasestorage.app",
      messagingSenderId: "858489773302",
      appId: "1:858489773302:web:21872c4b9df745c497a0d7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const grid = document.getElementById("grid");

    function pad(n) { return n.toString().padStart(2, "0"); }
    function tsToString(ts) {
      if (!ts) return "—";
      const d = ts.toDate();
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function createBusCard(busId, data) {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <h3>${busId}</h3>
        <div class="muted">Scanned (unique): <strong>${data?.numScanned ?? 0}</strong></div>
        <details>
          <summary>View scanned attendees</summary>
          <div class="muted">Newest first</div>
          <table>
            <thead>
              <tr><th>Code</th><th>Raw</th><th>Last scanned</th></tr>
            </thead>
            <tbody id="tb-${busId.replace(/\s+/g, '_')}">
              <tr><td colspan="3" class="muted">Loading…</td></tr>
            </tbody>
          </table>
        </details>
      `;
      return card;
    }

    function attachAttendeeListener(detailsEl, busId) {
      let unsub = null;
      detailsEl.addEventListener("toggle", () => {
        if (detailsEl.open && !unsub) {
          const tbody = document.getElementById(`tb-${busId.replace(/\s+/g, '_')}`);
          unsub = db.collection("buses").doc(busId)
            .collection("attendees")
            .orderBy("lastScannedAt", "desc")
            .onSnapshot((snap) => {
              tbody.innerHTML = "";
              if (snap.empty) {
                tbody.innerHTML = `<tr><td colspan="3" class="muted">No scans yet.</td></tr>`;
                return;
              }
              snap.forEach(doc => {
                const v = doc.data();
                const tr = document.createElement("tr");
                tr.innerHTML = `
                  <td>${v.code || "—"}</td>
                  <td>${v.raw || ""}</td>
                  <td>${tsToString(v.lastScannedAt)}</td>
                `;
                tbody.appendChild(tr);
              });
            });
        } else if (!detailsEl.open && unsub) {
          unsub();
          unsub = null;
        }
      });
    }

    // Build all bus cards
    const busIds = Array.from({ length: 12 }, (_, i) => `Bus ${i + 1}`);
    busIds.forEach(busId => {
      const card = createBusCard(busId, { numScanned: 0 });
      grid.appendChild(card);

      // Live count listener
      db.collection("buses").doc(busId)
        .onSnapshot(snap => {
          const data = snap.data() || { numScanned: 0 };
          card.querySelector(".muted").innerHTML = `Scanned (unique): <strong>${data.numScanned ?? 0}</strong>`;
        });

      // Attach attendee listener when opened
      attachAttendeeListener(card.querySelector("details"), busId);
    });
  </script>
</body>
</html>
