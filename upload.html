<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Upload Attendees & Generate Passes</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { font-size: 18px; margin: 0 0 12px; }
    .row { margin: 10px 0; }
    .btn { padding: 10px 14px; border: 1px solid #ddd; background: #f5f5f5; border-radius: 8px; cursor: pointer; }
    #log { white-space: pre-wrap; font-family: ui-monospace, monospace; background: #fafafa; border: 1px solid #eee; padding: 10px; border-radius: 8px; height: 160px; overflow: auto; }
    #preview { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px,1fr)); gap: 10px; margin-top: 10px; }
    canvas { width: 100%; height: auto; border: 1px solid #eee; border-radius: 6px; }
  </style>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Excel + ZIP + Save + PDF + QR libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <h1>Upload Attendees & Generate Passes</h1>

  <div class="row">
    <input type="file" id="excelFile" accept=".xlsx,.xls"/>
    <button class="btn" id="btnUpload">Upload to Firestore</button>
    <button class="btn" id="btnTemplate">â¬‡ Download Excel Template</button>
  </div>

  <div class="row">
    <button class="btn" id="btnGen">Generate Passes</button>
    <button class="btn" id="btnZip" disabled>ðŸ“¦ Download ZIP</button>
    <button class="btn" id="btnPdf" disabled>ðŸ“„ Download PDF (6 per A4)</button>
    <a class="btn" href="./scanner.html">Open Scanner</a>
    <a class="btn" href="./dashboard.html">Open Dashboard</a>
  </div>

  <div id="log"></div>
  <div id="preview"></div>

  <script>
    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCheUCoG-3z1OPkRAApPNO0S4AaBWW-WAc",
      authDomain: "bus-monitor-c6973.firebaseapp.com",
      projectId: "bus-monitor-c6973",
      storageBucket: "bus-monitor-c6973.firebasestorage.app",
      messagingSenderId: "858489773302",
      appId: "1:858489773302:web:21872c4b9df745c497a0d7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const logEl = document.getElementById('log');
    const preview = document.getElementById('preview');
    const btnUpload = document.getElementById('btnUpload');
    const btnGen = document.getElementById('btnGen');
    const btnZip = document.getElementById('btnZip');
    const btnPdf = document.getElementById('btnPdf');
    const btnTemplate = document.getElementById('btnTemplate');
    const fileInput = document.getElementById('excelFile');

    let rows = [];      // parsed rows from Excel: [{code,name,bus}, ...]
    let cards = [];     // generated canvases [{ code, name, bus, canvas }]

    function log(msg){ logEl.textContent += msg + "\n"; logEl.scrollTop = logEl.scrollHeight; }

    // Download template
    btnTemplate.onclick = () => {
      const data = [
        ['code','name','bus'],
        ['TCI01','Jane Doe','Bus 1'],
        ['TCI02','John Smith','Bus 2']
      ];
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Template');
      XLSX.writeFile(wb, 'Attendees_Template.xlsx');
    };

    function readExcel() {
      const f = fileInput.files[0];
      if (!f) { alert("Please choose an Excel file first."); return null; }
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, { type: 'array' });
          const sheet = wb.Sheets[wb.SheetNames[0]];
          const arr = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          const out = [];
          arr.slice(1).forEach(r => {
            if (!r || r.length < 3) return;
            const [code, name, bus] = r.map(v => String(v || '').trim());
            if (code && name && bus) out.push({ code, name, bus });
          });
          resolve(out);
        };
        reader.readAsArrayBuffer(f);
      });
    }

    // Upload to Firestore
    btnUpload.onclick = async () => {
      rows = await readExcel();
      if (!rows || rows.length === 0) { alert("No rows found."); return; }
      log(`Uploading ${rows.length} attendeesâ€¦`);

      // Group by bus for batch writes
      const chunkSize = 400;
      for (let i = 0; i < rows.length; i += chunkSize) {
        const chunk = rows.slice(i, i + chunkSize);
        const batch = db.batch();

        // Also ensure bus doc exists
        const touchedBuses = new Set();

        chunk.forEach(({ code, name, bus }) => {
          const attRef = db.collection('buses').doc(bus).collection('attendees').doc(code);
          batch.set(attRef, {
            code, name, bus,
            scanned: false,
            scannedAt: null
          }, { merge: true });
          touchedBuses.add(bus);
        });

        touchedBuses.forEach(bus => {
          const busRef = db.collection('buses').doc(bus);
          batch.set(busRef, { bus, updatedAt: new Date() }, { merge: true });
        });

        await batch.commit();
        log(`Committed ${Math.min(chunk.length, chunkSize)} recordsâ€¦`);
      }

      log("âœ… Upload complete.");
    };

    // Generate pass card canvas (simple, clean)
    function makeCard({ code, name, bus }) {
      const W = 700;           // px
      const H = 1000;          // px
      const c = document.createElement('canvas');
      c.width = W; c.height = H;
      const ctx = c.getContext('2d');

      // Background
      ctx.fillStyle = "#ffffff"; ctx.fillRect(0,0,W,H);
      ctx.strokeStyle = "#2eaad1"; ctx.lineWidth = 8; ctx.strokeRect(16,16,W-32,H-32);

      // Header
      ctx.fillStyle = "#2eaad1"; ctx.fillRect(16,16,W-32,80);
      ctx.fillStyle = "#fff"; ctx.font = "bold 34px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
      ctx.fillText("TSUNETETSU CEBU INC.", W/2, 16+40);

      // Bus
      ctx.fillStyle = "#000"; ctx.font = "bold 30px Arial";
      ctx.fillText(bus, W/2, 150);

      // QR
      const qrDiv = document.createElement('div');
      new QRCode(qrDiv, { text: code, width: 360, height: 360 });
      const qrCanvas = qrDiv.querySelector('canvas');
      ctx.drawImage(qrCanvas, (W-360)/2, 210);

      // Name + Code
      ctx.fillStyle = "#000"; ctx.font = "bold 30px Arial";
      ctx.fillText(name, W/2, 610);
      ctx.font = "22px Arial";
      ctx.fillText(`Code: ${code}`, W/2, 650);

      // Event / Venue boxes (simple)
      ctx.strokeStyle = "#2eaad1"; ctx.lineWidth = 3;
      ctx.strokeRect(40, 700, W-80, 90);
      ctx.fillStyle = "#2eaad1"; ctx.font = "bold 42px Arial";
      ctx.fillText("EVENT", W/2, 740);
      ctx.fillStyle = "#000"; ctx.font = "18px Arial";
      ctx.fillText("TCI Family Day 2025", W/2, 780);

      ctx.strokeStyle = "#2eaad1"; ctx.lineWidth = 3;
      ctx.strokeRect(40, 810, W-80, 90);
      ctx.fillStyle = "#2eaad1"; ctx.font = "bold 42px Arial";
      ctx.fillText("VENUE", W/2, 850);
      ctx.fillStyle = "#000"; ctx.font = "16px Arial";
      ctx.fillText("Hidden Valley Mountain and Wavepool Resort", W/2, 890);

      return c;
    }

    btnGen.onclick = async () => {
      rows = rows.length ? rows : await readExcel();
      if (!rows || rows.length === 0) { alert("Upload or choose a file first."); return; }

      cards = [];
      preview.innerHTML = "";
      log(`Generating ${rows.length} passesâ€¦`);
      for (const r of rows) {
        const canvas = makeCard(r);
        cards.push({ ...r, canvas });
        preview.appendChild(canvas);
      }
      btnZip.disabled = btnPdf.disabled = (cards.length === 0);
      log("âœ… Generation complete.");
    };

    btnZip.onclick = async () => {
      if (!cards.length) return;
      const zip = new JSZip();
      cards.forEach(({ code, canvas }) => {
        zip.file(`${code}.png`, canvas.toDataURL("image/png").split(",")[1], { base64: true });
      });
      const blob = await zip.generateAsync({ type: "blob" });
      saveAs(blob, "passes.zip");
    };

    btnPdf.onclick = async () => {
      if (!cards.length) return;
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit: "mm", format: "a4" });
      const cardW = 90;                 // width per card on A4
      const cardH = (1000/700) * cardW; // keep aspect ratio
      const marginX = 15, marginY = 12;
      const gapX = 10, gapY = 8;
      let col = 0, row = 0;

      for (let i=0; i<cards.length; i++) {
        const img = cards[i].canvas.toDataURL("image/png");
        const x = marginX + col * (cardW + gapX);
        const y = marginY + row * (cardH + gapY);
        pdf.addImage(img, "PNG", x, y, cardW, cardH);
        col++;
        if (col >= 2) { col = 0; row++; }
        if (row >= 3 && i !== cards.length - 1) { pdf.addPage(); row = 0; col = 0; }
      }
      pdf.save("passes.pdf");
    };
  </script>
</body>
</html>
