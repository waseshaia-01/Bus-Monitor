<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bus QR Monitor — Scanner</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    h1 { font-size: 18px; margin: 0; }
    a.btn { padding: 8px 14px; border-radius: 8px; background: #f0f0f0; text-decoration: none; color: #000; }
    label { font-weight: bold; }
    select { padding: 8px; margin-bottom: 12px; width: 100%; }
    #reader { width: 100%; max-width: 400px; margin: auto; }
    #status { margin-top: 10px; font-weight: bold; color: green; }
  </style>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- QR Scanner Library -->
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <header>
    <h1>Bus QR Monitor — Scanner</h1>
    <a class="btn" href="./dashboard.html">View Dashboard</a>
  </header>

  <label for="bus">Select Bus:</label>
  <select id="bus">
    <option value="">-- Select Bus --</option>
  </select>

  <div id="reader"></div>
  <div id="status">Idle</div>

  <script>
    // --- Your Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyCheUCoG-3z1OPkRAApPNO0S4AaBWW-WAc",
      authDomain: "bus-monitor-c6973.firebaseapp.com",
      projectId: "bus-monitor-c6973",
      storageBucket: "bus-monitor-c6973.firebasestorage.app",
      messagingSenderId: "858489773302",
      appId: "1:858489773302:web:21872c4b9df745c497a0d7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const statusDiv = document.getElementById("status");
    const busSelect = document.getElementById("bus");

    // Populate bus list
    for (let i = 1; i <= 12; i++) {
      const opt = document.createElement("option");
      opt.value = `Bus ${i}`;
      opt.textContent = `Bus ${i}`;
      busSelect.appendChild(opt);
    }

    async function saveScan(busId, rawCode) {
      if (!busId) {
        alert("Please select a bus first!");
        return;
      }
      const docId = rawCode.replaceAll("/", "_slash_").trim().slice(0, 150);
      const busRef = db.collection("buses").doc(busId);
      const attRef = busRef.collection("attendees").doc(docId);

      await db.runTransaction(async (tx) => {
        const attSnap = await tx.get(attRef);
        if (attSnap.exists) {
          tx.update(attRef, {
            count: firebase.firestore.FieldValue.increment(1),
            lastScannedAt: firebase.firestore.FieldValue.serverTimestamp(),
            raw: rawCode
          });
          tx.update(busRef, { updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        } else {
          tx.set(attRef, {
            code: docId,
            raw: rawCode,
            count: 1,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastScannedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          tx.set(busRef, {
            numScanned: firebase.firestore.FieldValue.increment(1),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        }
      });
      statusDiv.textContent = `Saved: ${rawCode} to ${busId}`;
    }

    // Scanner setup with Html5QrcodeScanner
    function onScanSuccess(decodedText) {
      const busId = busSelect.value;
      saveScan(busId, decodedText).catch(err => {
        console.error(err);
        statusDiv.textContent = "Error saving scan.";
      });
    }

    const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
    scanner.render(onScanSuccess);
  </script>
</body>
</html>
